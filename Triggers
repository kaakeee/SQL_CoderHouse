/*Tablas en donde van los datos de los triggers*/

USE pyme_stickers;
/* tabla de log de nuevas facturas con sus montos y usuarios que crearon la trabla y/o modificaciones*/
/* en esta tabla tomo mas datos porque es infomacion mas importante */
CREATE TABLE old_facturacion (
id_factura INT,       /* se elimina que sea primary key*/
cuit_cuil VARCHAR(40),
total_compra DECIMAL(30,2),
user CHAR(30),            /* user y fecha para saber quien hizo los cambios y cuando   */
fecha_hora timestamp
);

/*tabla de registro de nuevas ventas, de la tabla pedidos */ 

CREATE TABLE new_pedidos(
id_pedido INT,   /* se elimina que sea primary key*/
user CHAR(30),    /* user y fecha para saber quien hizo los cambios y cuando   */
fecha_hora timestamp
);




/* trigger que ve las modificaciones de la tabla facturacion, copiando los anteriores*/

CREATE TRIGGER tr_facturas
AFTER update ON facturacion /* despues del update*/  /* la tabla*/
FOR EACH ROW /*cada fila q se inserte*/
INSERT INTO old_facturacion (id_factura, cuit_cuil, total_compra, user, fecha_hora)  /* la tabla/columnas que queremos copiar*/
VALUES (old.id_factura, old.cuit_cuil, old.total_compra, session_user(), current_timestamp());     /*los datos que queremos copiar a la nueva tabla de auditoria*/


/* trigger que ve el id_pedido nuevos en la tabla pedidos, quien los anota y cuando*/

CREATE TRIGGER tr_pedidos
BEFORE INSERT on pedidos
FOR EACH ROW
INSERT INTO new_pedidos (id_pedido, user, fecha_hora)
VALUES (NEW.id_pedido, session_user(), current_timestamp());


